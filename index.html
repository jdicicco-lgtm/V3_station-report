<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Dashboard Performance – Dicembre 2025</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:"Segoe UI",Arial,sans-serif;
  margin:0 auto;
  padding:24px;
  max-width:1600px;
  background:linear-gradient(180deg,#f2f5f9,#e9edf3);
  color:#1f2937;
}
h1{font-size:26px}
h2{margin:30px 0 15px;font-size:18px;font-weight:600}
section{margin-bottom:36px}

.filter-bar{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  padding:14px;
  background:#ffffffcc;
  border-radius:12px;
  box-shadow:0 4px 14px rgba(0,0,0,.06);
}

select,input[type=date]{
  padding:8px 10px;
  border-radius:8px;
  border:1px solid #d1d5db;
  font-size:13px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:20px;
}

.card{
  background:#fff;
  padding:18px;
  border-radius:14px;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
}
.card h4{margin:0;font-size:13px;color:#6b7280}
.card span{font-size:28px;font-weight:700;margin-top:6px;display:block}

.chart-box{
  background:#fff;
  padding:14px;
  border-radius:14px;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
  height:420px;
}

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
}
th,td{
  padding:12px;
  border-bottom:1px solid #e5e7eb;
}
th{
  background:#f3f6fb;
  text-transform:uppercase;
  font-size:12px;
}
</style>
</head>

<body>

<h1>Dashboard Performance – Dicembre 2025</h1>

<section class="filter-bar">
  <label>Da</label><input type="date" id="fromDate">
  <label>A</label><input type="date" id="toDate">
  <select id="branchFilter"><option value="">Tutti i Branch</option></select>
</section>

<section>
<h2>KPI Commerciali</h2>
<div class="grid">
  <div class="card"><h4>Revenue Totale</h4><span id="kpiRevenue">–</span></div>
  <div class="card"><h4>Prenotazioni</h4><span id="kpiBookings">–</span></div>
  <div class="card"><h4>Ancillaries</h4><span id="kpiAnc">–</span></div>
</div>
</section>

<section>
<h2>Peak Analysis – Domanda vs Flotta</h2>
<div class="chart-box">
  <canvas id="peakChart"></canvas>
</div>
</section>

<section>
<h2>Performance Operativa per Branch</h2>
<table>
<thead>
<tr>
  <th>Branch</th>
  <th>Prenotazioni</th>
  <th>Revenue Totale</th>
  <th>Revenue Media</th>
  <th>% su Totale</th>
</tr>
</thead>
<tbody id="perfTable"></tbody>
</table>
</section>

<script>
Chart.defaults.maintainAspectRatio=false;

const COLORS={
  primary:"#1f3c88",
  secondary:"#4f81bd",
  accent:"#f28e2b",
  dashed:"#9ca3af"
};

let peakChart;

/* ===== LOAD DATA ===== */
Promise.all([
  fetch("fleet.json").then(r=>r.json()),
  fetch("service.json").then(r=>r.json()),
  fetch("bookings.json").then(r=>r.json())
]).then(init);

/* ===== UTILS ===== */
function parseDateTime(dt){
  const [d,t]=dt.split(" ");
  const [dd,mm,yyyy]=d.split("/");
  const [hh,min]=t.split(":");
  return new Date(yyyy,mm-1,dd,hh,min);
}

function buildDailySeries(bookings,from,to){
  const out={};
  const cur=new Date(from);
  while(cur<=to){
    out[cur.toISOString().slice(0,10)]={count:0,revenue:0};
    cur.setDate(cur.getDate()+1);
  }
  bookings.forEach(b=>{
    const k=b.date.toISOString().slice(0,10);
    if(out[k]){
      out[k].count++;
      out[k].revenue+=b.revenue;
    }
  });
  return out;
}

function movingAverage(values,window){
  return values.map((_,i)=>{
    const slice=values.slice(Math.max(0,i-window+1),i+1);
    return slice.reduce((s,v)=>s+v,0)/slice.length;
  });
}

/* ===== INIT ===== */
function init([fleet,service,raw]){

  const fleetTotal=fleet.length;
  const inService=service.length;
  const fleetAvailable=fleetTotal-inService;

  const bookings=raw.map(b=>({
    branch:b["brach office"],
    revenue:Number(b.revenue||0),
    anc:Number(b["Ancillaries vendute"]||0),
    date:parseDateTime(b.from)
  }));

  branchFilter.innerHTML+=
    [...new Set(bookings.map(b=>b.branch))].map(b=>`<option>${b}</option>`).join("");

  branchFilter.onchange=apply;
  fromDate.onchange=apply;
  toDate.onchange=apply;

  function apply(){
    const f=bookings.filter(b=>{
      if(branchFilter.value && b.branch!==branchFilter.value) return false;
      if(fromDate.value && b.date<new Date(fromDate.value)) return false;
      if(toDate.value && b.date>new Date(toDate.value)) return false;
      return true;
    });

    updateKPIs(f);
    updatePeak(f,fleetAvailable);
    updateTable(f);
  }

  apply();
}

/* ===== KPI ===== */
function updateKPIs(d){
  kpiRevenue.textContent="€ "+d.reduce((s,b)=>s+b.revenue,0).toFixed(2);
  kpiBookings.textContent=d.length;
  kpiAnc.textContent="€ "+d.reduce((s,b)=>s+b.anc,0).toFixed(2);
}

/* ===== PEAK ===== */
function updatePeak(d,fleetAvailable){
  if(peakChart) peakChart.destroy();

  const from=new Date(fromDate.value||Math.min(...d.map(b=>b.date)));
  const to=new Date(toDate.value||Math.max(...d.map(b=>b.date)));

  const daily=buildDailySeries(d,from,to);
  const labels=Object.keys(daily);
  const counts=labels.map(l=>daily[l].count);
  const revenues=labels.map(l=>daily[l].revenue);
  const ma7=movingAverage(counts,7);
  const fleetLine=labels.map(()=>fleetAvailable);

  peakChart=new Chart(peakChartEl,{
    type:"line",
    data:{
      labels,
      datasets:[
        {
          label:"Prenotazioni",
          data:counts,
          borderColor:COLORS.primary,
          fill:false,
          tension:0.3
        },
        {
          label:"Media mobile 7gg",
          data:ma7,
          borderColor:COLORS.secondary,
          borderDash:[6,4],
          fill:false
        },
        {
          label:"Flotta disponibile",
          data:fleetLine,
          borderColor:COLORS.dashed,
          borderDash:[3,3],
          fill:false
        }
      ]
    },
    options:{
      plugins:{
        tooltip:{
          callbacks:{
            afterBody:(ctx)=>{
              const i=ctx[0].dataIndex;
              return "Revenue: € "+revenues[i].toFixed(2);
            }
          }
        }
      }
    }
  });
}

/* ===== TABLE ===== */
function updateTable(d){
  perfTable.innerHTML="";
  const totalRev=d.reduce((s,b)=>s+b.revenue,0);

  const grouped={};
  d.forEach(b=>{
    grouped[b.branch]=grouped[b.branch]||{count:0,rev:0};
    grouped[b.branch].count++;
    grouped[b.branch].rev+=b.revenue;
  });

  Object.entries(grouped).forEach(([k,v])=>{
    perfTable.innerHTML+=`
      <tr>
        <td>${k}</td>
        <td>${v.count}</td>
        <td>€ ${v.rev.toFixed(2)}</td>
        <td>€ ${(v.rev/v.count).toFixed(2)}</td>
        <td>${((v.rev/totalRev)*100).toFixed(1)}%</td>
      </tr>`;
  });
}
</script>

</body>
</html>
