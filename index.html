<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Performance – Dicembre 2025</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
  /* ===== BASE ===== */
  body {
    font-family: Arial, sans-serif;
    background: #f4f6f9;
    margin: 0 auto;
    padding: 20px;
    max-width: 1400px;
  }

  h1 {
    margin-bottom: 10px;
  }

  h2 {
    margin-bottom: 20px;
    font-size: 18px;
    font-weight: 600;
    color: #222;
  }

  section {
    margin-bottom: 40px;
  }

  /* ===== GRID ===== */
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
  }

  /* ===== CARD ===== */
  .card {
    background: white;
    padding: 18px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }

  .card h4 {
    margin: 0;
    font-size: 14px;
    color: #555;
  }

  .card span {
    font-size: 28px;
    font-weight: bold;
    display: block;
    margin-top: 6px;
  }

  .card small {
    color: #777;
    display: block;
    margin-top: 6px;
  }

  /* ===== FILTER ===== */
  select {
    padding: 6px;
    margin-right: 10px;
  }

  /* ===== TABLE ===== */
  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    margin-top: 10px;
  }

  th, td {
    padding: 8px;
    border-bottom: 1px solid #ddd;
    text-align: left;
  }

  th {
    background: #eee;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  td {
    font-size: 14px;
  }

  /* ===== CHART ===== */
  .chart-box {
    background: white;
    padding: 12px;
    border-radius: 8px;
    height: 320px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .chart-box canvas {
    max-width: 100%;
    max-height: 100%;
  }

  /* ===== RESPONSIVE ===== */
  @media (min-width: 1600px) {
    body {
      max-width: 1600px;
    }
  }

  @media (max-width: 1366px) {
    .grid {
      gap: 16px;
    }

    .card span {
      font-size: 24px;
    }

    h2 {
      font-size: 16px;
    }
  }
  </style>
</head>

<body>

<h1>Dashboard Performance – Dicembre 2025</h1>

<!-- ================= FILTRI ================= -->
<section>
  <select id="branchFilter">
    <option value="">Tutti i Branch</option>
  </select>

  <select id="agentFilter">
    <option value="">Tutti gli Agenti</option>
  </select>
</section>

<!-- ================= DATI STRUTTURALI ================= -->
<section>
  <h2>Dati Strutturali (NON Filtrabili)</h2>
  <div class="grid" id="structuralCards"></div>
</section>

<!-- ================= KPI ================= -->
<section>
  <h2>KPI Commerciali (Filtrabili)</h2>
  <div class="grid">
    <div class="card">
      <h4>Revenue Totale</h4>
      <span id="revenueTotal">–</span>
      <small id="revenueDay"></small>
    </div>

    <div class="card">
      <h4>Prenotazioni</h4>
      <span id="bookingTotal">–</span>
    </div>

    <div class="card">
      <h4>Incidenti (€)</h4>
      <span id="incidentTotal">–</span>
    </div>
  </div>
</section>

<!-- ================= GRAFICI ================= -->
<section>
  <h2>Analisi Prenotazioni</h2>
  <div class="grid">
    <div class="chart-box">
      <canvas id="channelChart"></canvas>
    </div>

    <div class="chart-box">
      <canvas id="providerChart"></canvas>
    </div>
  </div>
</section>

<section>
  <h2>Peak Analysis</h2>
  <div class="chart-box" style="height:360px">
    <canvas id="timeChart"></canvas>
  </div>
</section>

<!-- ================= TABELLA ================= -->
<section>
  <h2>Performance Operativa</h2>
  <table>
    <thead>
      <tr>
        <th>Branch</th>
        <th>Agente</th>
        <th>Revenue</th>
        <th>Prenotazioni</th>
      </tr>
    </thead>
    <tbody id="performanceTable"></tbody>
  </table>
</section>

<script>
/* ===== GLOBAL ===== */
Chart.defaults.maintainAspectRatio = false;

const COLORS = {
  primary: "#1f3c88",
  secondary: "#4f81bd",
  accent: "#f28e2b"
};

let charts = {};

/* ===== LOAD DATA ===== */
Promise.all([
  fetch("fleet.json").then(r => r.json()),
  fetch("utilization.json").then(r => r.json()),
  fetch("service.json").then(r => r.json()),
  fetch("incidenti.json").then(r => r.json()),
  fetch("bookings.json").then(r => r.json())
]).then(initDashboard);

/* ===== INIT ===== */
function initDashboard([fleet, utilization, service, incidents, bookings]) {

  /* ---- Structural ---- */
  const structural = document.getElementById("structuralCards");
  structural.innerHTML += card("Flotta Totale", fleet.length);

  utilization.forEach(b => {
    structural.innerHTML += card(
      `Occupazione ${b["Branch Offices"]}`,
      (b.Occupation * 100).toFixed(1) + "%"
    );
  });

  const avgOcc =
    utilization.reduce((s, b) => s + b.Occupation, 0) / utilization.length;

  structural.innerHTML += card(
    "Occupazione Media",
    (avgOcc * 100).toFixed(1) + "%"
  );

  /* ---- Filters ---- */
  populateFilter("branchFilter", [...new Set(bookings.map(b => b.Branch))]);
  populateFilter("agentFilter", [...new Set(bookings.map(b => b.Agent))]);

  branchFilter.onchange = applyFilters;
  agentFilter.onchange = applyFilters;

  function applyFilters() {
    const filtered = bookings.filter(b =>
      (!branchFilter.value || b.Branch === branchFilter.value) &&
      (!agentFilter.value || b.Agent === agentFilter.value)
    );

    updateKPIs(filtered, incidents);
    updateCharts(filtered);
    updateTable(filtered);
  }

  applyFilters();

  /* ---- KPI ---- */
  function updateKPIs(data, incidents) {
    const revenue = data.reduce((s, b) => s + (b.Revenue || 0), 0);
    revenueTotal.textContent = "€ " + revenue.toFixed(2);
    bookingTotal.textContent = data.length;

    const days = new Set(data.map(b => b.Date)).size || 1;
    revenueDay.textContent =
      "€ " + (revenue / days).toFixed(2) + " / giorno";

    const incidentCost = incidents.reduce(
      (s, i) => s + (i["Total price"] || 0), 0
    );
    incidentTotal.textContent = "€ " + incidentCost.toFixed(2);
  }

  /* ---- Charts ---- */
  function updateCharts(data) {
    destroyCharts();

    charts.channel = donutChart(
      "channelChart",
      groupCount(data, "Channel"),
      "Prenotazioni per Canale"
    );

    charts.provider = barChart(
      "providerChart",
      groupCount(data, "Provider"),
      "Prenotazioni per Provider"
    );

    charts.time = lineChart("timeChart", data);
  }

  /* ---- Table ---- */
  function updateTable(data) {
    performanceTable.innerHTML = "";
    const grouped = {};

    data.forEach(b => {
      const key = b.Branch + "|" + b.Agent;
      if (!grouped[key]) {
        grouped[key] = { Branch: b.Branch, Agent: b.Agent, Revenue: 0, Count: 0 };
      }
      grouped[key].Revenue += b.Revenue || 0;
      grouped[key].Count++;
    });

    Object.values(grouped).forEach(r => {
      performanceTable.innerHTML += `
        <tr>
          <td>${r.Branch}</td>
          <td>${r.Agent}</td>
          <td>€ ${r.Revenue.toFixed(2)}</td>
          <td>${r.Count}</td>
        </tr>`;
    });
  }
}

/* ===== UTIL ===== */
function card(title, value) {
  return `<div class="card"><h4>${title}</h4><span>${value}</span></div>`;
}

function populateFilter(id, values) {
  const el = document.getElementById(id);
  values.filter(Boolean).sort().forEach(v => {
    el.innerHTML += `<option value="${v}">${v}</option>`;
  });
}

function groupCount(data, key) {
  return data.reduce((o, b) => {
    o[b[key]] = (o[b[key]] || 0) + 1;
    return o;
  }, {});
}

function destroyCharts() {
  Object.values(charts).forEach(c => c && c.destroy());
}

/* ===== CHARTS ===== */
function donutChart(id, data, title) {
  const labels = Object.keys(data);
  const values = Object.values(data);
  const colors = labels.map(l =>
    l.toLowerCase().includes("walk") ? COLORS.accent : COLORS.secondary
  );

  return new Chart(document.getElementById(id), {
    type: "doughnut",
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: colors,
        borderColor: "#fff",
        borderWidth: 1
      }]
    },
    options: {
      plugins: {
        title: { display: true, text: title },
        legend: { position: "bottom" }
      }
    }
  });
}

function barChart(id, data, title) {
  return new Chart(document.getElementById(id), {
    type: "bar",
    data: {
      labels: Object.keys(data),
      datasets: [{
        data: Object.values(data),
        backgroundColor: COLORS.primary
      }]
    },
    options: {
      plugins: {
        title: { display: true, text: title },
        legend: { display: false }
      }
    }
  });
}

function lineChart(id, data) {
  const daily = {};
  data.forEach(b => {
    daily[b.Date] = (daily[b.Date] || 0) + 1;
  });

  return new Chart(document.getElementById(id), {
    type: "line",
    data: {
      labels: Object.keys(daily),
      datasets: [{
        label: "Prenotazioni",
        data: Object.values(daily),
        borderColor: COLORS.primary,
        fill: false
      }]
    }
  });
}
</script>

</body>
</html>
