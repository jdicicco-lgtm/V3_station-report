<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Dashboard Performance – Dicembre 2025</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:"Segoe UI",Arial,sans-serif;
  margin:0 auto;
  padding:24px;
  max-width:1600px;
  background:linear-gradient(180deg,#f2f5f9,#e9edf3);
  color:#1f2937;
}
h1{font-size:26px}
h2{margin:30px 0 15px;font-size:18px;font-weight:600}
section{margin-bottom:36px}
.filter-bar{
  display:flex;gap:10px;flex-wrap:wrap;
  background:#fff;padding:14px;border-radius:12px;
}
select,input[type=date]{padding:8px;border-radius:8px;border:1px solid #d1d5db}
.chart-box{
  background:#fff;padding:14px;border-radius:14px;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
  height:420px;
}
table{
  width:100%;border-collapse:collapse;background:#fff;
  border-radius:14px;overflow:hidden;
}
th,td{padding:12px;border-bottom:1px solid #e5e7eb}
th{background:#f3f6fb;font-size:12px;text-transform:uppercase}
</style>
</head>

<body>

<h1>Dashboard Performance – Dicembre 2025</h1>

<section class="filter-bar">
  <label>Da</label><input type="date" id="fromDate">
  <label>A</label><input type="date" id="toDate">
</section>

<section>
<h2>Peak Analysis – Domanda vs Flotta</h2>
<div class="chart-box">
  <canvas id="peakChart"></canvas>
</div>
</section>

<section>
<h2>Performance Operativa per Branch</h2>
<table>
<thead>
<tr>
  <th>Branch</th>
  <th>Prenotazioni</th>
  <th>Revenue Totale</th>
  <th>Rev / Booking</th>
  <th>Peso %</th>
</tr>
</thead>
<tbody id="perfTable"></tbody>
</table>
</section>

<script>
Chart.defaults.maintainAspectRatio=false;
const COLORS={primary:"#1f3c88",secondary:"#4f81bd",fleet:"#9ca3af"};
let peakChart;

Promise.all([
  fetch("fleet.json").then(r=>r.json()),
  fetch("service.json").then(r=>r.json()),
  fetch("bookings.json").then(r=>r.json())
]).then(init);

function parseDateTime(dt){
  const [d,t]=dt.split(" ");
  const [dd,mm,yyyy]=d.split("/");
  const [hh,min]=t.split(":");
  return new Date(yyyy,mm-1,dd,hh,min);
}

function getMinDate(arr){ return new Date(Math.min(...arr.map(d=>d.getTime()))); }
function getMaxDate(arr){ return new Date(Math.max(...arr.map(d=>d.getTime()))); }

function buildDailySeries(bookings,from,to){
  const out={};
  const cur=new Date(from);
  while(cur<=to){
    const k=cur.toISOString().slice(0,10);
    out[k]={count:0,revenue:0};
    cur.setDate(cur.getDate()+1);
  }
  bookings.forEach(b=>{
    const k=b.date.toISOString().slice(0,10);
    if(out[k]){
      out[k].count++;
      out[k].revenue+=b.revenue;
    }
  });
  return out;
}

function movingAverage(arr,w){
  return arr.map((_,i)=>{
    const s=arr.slice(Math.max(0,i-w+1),i+1);
    return s.reduce((a,b)=>a+b,0)/s.length;
  });
}

function init([fleet,service,raw]){
  const fleetAvailable=fleet.length-service.length;

  const bookings=raw.map(b=>({
    branch:b["brach office"],
    revenue:+b.revenue||0,
    date:parseDateTime(b.from)
  }));

  fromDate.onchange=apply;
  toDate.onchange=apply;

  function apply(){
    const f=bookings.filter(b=>{
      if(fromDate.value && b.date<new Date(fromDate.value)) return false;
      if(toDate.value && b.date>new Date(toDate.value)) return false;
      return true;
    });

    updatePeak(f,fleetAvailable);
    updateTable(f);
  }

  apply();
}

function updatePeak(d,fleetAvailable){
  if(peakChart) peakChart.destroy();
  if(d.length===0) return;

  const from=fromDate.value ? new Date(fromDate.value) : getMinDate(d.map(b=>b.date));
  const to=toDate.value ? new Date(toDate.value) : getMaxDate(d.map(b=>b.date));

  const daily=buildDailySeries(d,from,to);
  const labels=Object.keys(daily);
  const counts=labels.map(k=>daily[k].count);
  const revenues=labels.map(k=>daily[k].revenue);
  const ma7=movingAverage(counts,7);
  const fleetLine=labels.map(()=>fleetAvailable);

  peakChart=new Chart(peakChart,{
    type:"line",
    data:{
      labels,
      datasets:[
        {label:"Prenotazioni",data:counts,borderColor:COLORS.primary,tension:.3},
        {label:"Media mobile 7gg",data:ma7,borderColor:COLORS.secondary,borderDash:[6,4]},
        {label:"Flotta disponibile",data:fleetLine,borderColor:COLORS.fleet,borderDash:[3,3]}
      ]
    },
    options:{
      plugins:{
        tooltip:{
          callbacks:{
            afterBody:(ctx)=>"Revenue: € "+revenues[ctx[0].dataIndex].toFixed(2)
          }
        }
      },
      scales:{y:{beginAtZero:true}}
    }
  });
}

function updateTable(d){
  perfTable.innerHTML="";
  const total=d.reduce((s,b)=>s+b.revenue,0);
  const g={};

  d.forEach(b=>{
    g[b.branch]=g[b.branch]||{c:0,r:0};
    g[b.branch].c++; g[b.branch].r+=b.revenue;
  });

  Object.entries(g).forEach(([k,v])=>{
    perfTable.innerHTML+=`
      <tr>
        <td>${k}</td>
        <td>${v.c}</td>
        <td>€ ${v.r.toFixed(2)}</td>
        <td>€ ${(v.r/v.c).toFixed(2)}</td>
        <td>${((v.r/total)*100).toFixed(1)}%</td>
      </tr>`;
  });
}
</script>

</body>
</html>
