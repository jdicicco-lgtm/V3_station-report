<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Dashboard Performance â€“ Dicembre 2025</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:"Segoe UI",Arial,sans-serif;
  margin:0 auto;
  padding:24px;
  max-width:1600px;
  background:linear-gradient(180deg,#f2f5f9,#e9edf3);
  color:#1f2937;
}
h1{font-size:26px;margin-bottom:10px}
h2{margin:30px 0 15px;font-size:18px;font-weight:600}
section{margin-bottom:36px}

.filter-bar{
  display:flex;
  gap:10px;
  padding:14px;
  background:#fff;
  border-radius:12px;
  box-shadow:0 4px 14px rgba(0,0,0,.06);
}

select,input[type=date]{
  padding:8px 10px;
  border-radius:8px;
  border:1px solid #d1d5db;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
}

.card{
  background:#fff;
  padding:18px;
  border-radius:14px;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
}
.card h4{margin:0;font-size:13px;color:#6b7280}
.card span{font-size:26px;font-weight:700;display:block;margin-top:6px}
.card small{font-size:12px;color:#6b7280}

.chart-box{
  background:#fff;
  padding:14px;
  border-radius:14px;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
  height:380px;
}

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
}
th,td{
  padding:12px;
  border-bottom:1px solid #e5e7eb;
}
th{
  background:#f3f6fb;
  font-size:12px;
  text-transform:uppercase;
}
</style>
</head>

<body>

<h1>Dashboard Performance â€“ Dicembre 2025</h1>

<section class="filter-bar">
  <label>Da</label><input type="date" id="fromDate">
  <label>A</label><input type="date" id="toDate">
</section>

<!-- ================= FLOTTA STRUTTURALE ================= -->
<section>
<h2>Flotta â€“ Dati Strutturali</h2>
<div class="grid" id="fleetCards"></div>
</section>

<!-- ================= MANUTENZIONE ================= -->
<section>
<h2>Manutenzione â€“ Veicoli in Service</h2>
<div class="chart-box"><canvas id="serviceChart"></canvas></div>
</section>

<!-- ================= PROVIDER ================= -->
<section>
<h2>Prenotazioni per Provider</h2>
<div class="chart-box"><canvas id="providerChart"></canvas></div>
</section>

<!-- ================= KPI ================= -->
<section>
<h2>KPI Commerciali</h2>
<div class="grid">
  <div class="card"><h4>Revenue Totale</h4><span id="kpiRevenue">â€“</span></div>
  <div class="card"><h4>Prenotazioni</h4><span id="kpiBookings">â€“</span></div>
  <div class="card"><h4>Ancillaries</h4><span id="kpiAnc">â€“</span></div>
</div>
</section>

<!-- ================= PEAK ================= -->
<section>
<h2>Peak Analysis â€“ Domanda vs Flotta</h2>
<div class="chart-box"><canvas id="peakChart"></canvas></div>
</section>

<!-- ================= PERFORMANCE ================= -->
<section>
<h2>Performance Operativa per Branch</h2>
<table>
<thead>
<tr>
  <th>Branch</th>
  <th>Prenotazioni</th>
  <th>Revenue Totale</th>
  <th>Rev / Booking</th>
  <th>Peso %</th>
</tr>
</thead>
<tbody id="perfTable"></tbody>
</table>
</section>

<script>
Chart.defaults.maintainAspectRatio=false;
const COLORS={
  primary:"#1f3c88",
  secondary:"#4f81bd",
  accent:"#f28e2b",
  grey:"#9ca3af"
};

let charts={};

Promise.all([
  fetch("fleet.json").then(r=>r.json()),
  fetch("utilization.json").then(r=>r.json()),
  fetch("service.json").then(r=>r.json()),
  fetch("bookings.json").then(r=>r.json())
]).then(init);

function parseDateTime(dt){
  if(!dt) return null;
  const [d,t]=dt.split(" ");
  const [dd,mm,yyyy]=d.split("/");
  const [hh,min]=t.split(":");
  return new Date(yyyy,mm-1,dd,hh,min);
}

function groupCount(arr,key){
  return arr.reduce((o,x)=>{
    o[x[key]]=(o[x[key]]||0)+1;
    return o;
  },{});
}

function buildDailySeries(bookings,from,to){
  const map={};
  const cur=new Date(from);
  while(cur<=to){
    map[cur.toISOString().slice(0,10)]={count:0,rev:0};
    cur.setDate(cur.getDate()+1);
  }
  bookings.forEach(b=>{
    const k=b.date.toISOString().slice(0,10);
    if(map[k]){
      map[k].count++;
      map[k].rev+=b.revenue;
    }
  });
  return map;
}

function movingAverage(arr,w){
  return arr.map((_,i)=>{
    const s=arr.slice(Math.max(0,i-w+1),i+1);
    return s.reduce((a,b)=>a+b,0)/s.length;
  });
}

function init([fleet,util,service,rawBookings]){

  /* ===== FLOTTA STRUTTURALE ===== */
  fleetCards.innerHTML+=card("Flotta Totale",fleet.length);

  util.forEach(u=>{
    fleetCards.innerHTML+=`
      <div class="card">
        <h4>${u["Branch Offices"]}</h4>
        <span>${(u.Occupation*100).toFixed(1)}%</span>
        <small>Occupazione</small>
      </div>`;
  });

  const avgOcc=util.reduce((s,u)=>s+u.Occupation,0)/util.length;
  fleetCards.innerHTML+=card("Occupazione Media",(avgOcc*100).toFixed(1)+"%");

  /* ===== MANUTENZIONE ===== */
  charts.service=new Chart(serviceChart,{
    type:"bar",
    data:{
      labels:Object.keys(groupCount(service,"Type")),
      datasets:[{
        data:Object.values(groupCount(service,"Type")),
        backgroundColor:COLORS.secondary
      }]
    }
  });

  /* ===== NORMALIZZA BOOKINGS ===== */
  const bookings=rawBookings.map(b=>({
    branch:b["brach office"],
    provider:b.Provider,
    revenue:+b.revenue||0,
    anc:+b["Ancillaries vendute"]||0,
    date:parseDateTime(b.from)
  })).filter(b=>b.date);

  /* ===== PROVIDER ===== */
  charts.provider=new Chart(providerChart,{
    type:"bar",
    data:{
      labels:Object.keys(groupCount(bookings,"provider")),
      datasets:[{
        data:Object.values(groupCount(bookings,"provider")),
        backgroundColor:COLORS.primary
      }]
    }
  });

  fromDate.onchange=apply;
  toDate.onchange=apply;

  apply();

  function apply(){
    const filtered=bookings.filter(b=>{
      if(fromDate.value && b.date<new Date(fromDate.value)) return false;
      if(toDate.value && b.date>new Date(toDate.value)) return false;
      return true;
    });

    updateKPIs(filtered);
    updatePeak(filtered,fleet.length-service.length);
    updateTable(filtered);
  }
}

function updateKPIs(d){
  kpiRevenue.textContent="â‚¬ "+d.reduce((s,b)=>s+b.revenue,0).toFixed(2);
  kpiBookings.textContent=d.length;
  kpiAnc.textContent="â‚¬ "+d.reduce((s,b)=>s+b.anc,0).toFixed(2);
}

function updatePeak(d,fleetAvailable){
  if(charts.peak){charts.peak.destroy();charts.peak=null;}
  if(d.length===0) return;

  const dates=d.map(b=>b.date);
  const from=fromDate.value?new Date(fromDate.value):new Date(Math.min(...dates));
  const to=toDate.value?new Date(toDate.value):new Date(Math.max(...dates));

  const daily=buildDailySeries(d,from,to);
  const labels=Object.keys(daily);
  const counts=labels.map(k=>daily[k].count);
  const revenues=labels.map(k=>daily[k].rev);
  const ma7=movingAverage(counts,7);
  const fleetLine=labels.map(()=>fleetAvailable);

  charts.peak=new Chart(document.getElementById("peakChart"),{
    type:"line",
    datasets:[
  {
    label:"Prenotazioni",
    data:counts,
    borderColor:COLORS.primary,
    tension:0.3
  },
  {
    label:"Media mobile 7gg",
    data:ma7,
    borderColor:COLORS.secondary,
    borderDash:[6,4]
  },
  {
    label:"Flotta disponibile",
    data:fleetLine,
    borderColor:COLORS.grey,
    borderDash:[3,3]
  },
  {
    label:"Revenue (hidden)",
    data:revenues,
    hidden:true        // ðŸ‘ˆ solo per tooltip
  }
]

    },
   options:{
  scales:{
    y:{
      beginAtZero:true,
      grace:"30%",
      ticks:{ precision:0 }
    }
  },
  plugins:{
    tooltip:{
      callbacks:{
        afterBody:(ctx)=>{
          const i = ctx[0].dataIndex;
          const revenue =
            ctx[0].chart.data.datasets[3].data[i] || 0;
          return "Revenue: â‚¬ " + revenue.toFixed(2);
        }
      }
    }
  }
}

function updateTable(d){
  perfTable.innerHTML="";
  if(d.length===0) return;

  const total=d.reduce((s,b)=>s+b.revenue,0);
  const g={};

  d.forEach(b=>{
    g[b.branch]=g[b.branch]||{c:0,r:0};
    g[b.branch].c++;
    g[b.branch].r+=b.revenue;
  });

  Object.entries(g).forEach(([k,v])=>{
    perfTable.innerHTML+=`
      <tr>
        <td>${k}</td>
        <td>${v.c}</td>
        <td>â‚¬ ${v.r.toFixed(2)}</td>
        <td>â‚¬ ${(v.r/v.c).toFixed(2)}</td>
        <td>${((v.r/total)*100).toFixed(1)}%</td>
      </tr>`;
  });
}

function card(t,v){
  return `<div class="card"><h4>${t}</h4><span>${v}</span></div>`;
}
</script>

</body>
</html>
