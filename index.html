<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Dashboard Performance – Dicembre 2025</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ===== THEME ===== */
body{
  font-family: "Segoe UI", Arial, sans-serif;
  margin: 0 auto;
  padding: 24px;
  max-width: 1500px;
  background: linear-gradient(180deg,#f2f5f9 0%,#e9edf3 100%);
  color: #1f2937;
}

h1{
  font-size: 26px;
  margin-bottom: 10px;
}

h2{
  margin: 30px 0 15px;
  font-size: 18px;
  font-weight: 600;
}

section{
  margin-bottom: 36px;
}

/* ===== FILTER BAR ===== */
.filter-bar{
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  background: #ffffffcc;
  padding: 14px;
  border-radius: 12px;
  box-shadow: 0 4px 14px rgba(0,0,0,.06);
}

select, input[type=date]{
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  background: white;
  font-size: 13px;
}

/* ===== GRID ===== */
.grid{
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(240px,1fr));
  gap: 20px;
}

/* ===== CARD ===== */
.card{
  background: #ffffff;
  padding: 18px;
  border-radius: 14px;
  box-shadow: 0 8px 24px rgba(0,0,0,.06);
}

.card h4{
  margin: 0;
  font-size: 13px;
  color: #6b7280;
}

.card span{
  font-size: 28px;
  font-weight: 700;
  margin-top: 6px;
  display: block;
}

/* ===== CHART ===== */
.chart-box{
  background: #ffffff;
  padding: 14px;
  border-radius: 14px;
  box-shadow: 0 8px 24px rgba(0,0,0,.06);
  height: 320px;
}

.chart-box.large{
  height: 400px;
}

/* ===== TABLE ===== */
table{
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 8px 24px rgba(0,0,0,.06);
}

th, td{
  padding: 10px;
  border-bottom: 1px solid #e5e7eb;
  font-size: 14px;
}

th{
  background: #f3f6fb;
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: .04em;
}

@media (min-width: 1600px){
  body{max-width: 1600px;}
}
</style>
</head>

<body>

<h1>Dashboard Performance – Dicembre 2025</h1>

<!-- ===== FILTRI ===== -->
<section class="filter-bar">
  <label>Da</label><input type="date" id="fromDate">
  <label>A</label><input type="date" id="toDate">
  <select id="branchFilter"><option value="">Tutti i Branch</option></select>
  <select id="agentFilter"><option value="">Tutti gli Agenti</option></select>
</section>

<!-- ===== FLOTTA ===== -->
<section>
<h2>Flotta – Dati Strutturali</h2>
<div class="grid" id="fleetCards"></div>
</section>

<section>
<h2>Prenotazioni per Provider</h2>
<div class="chart-box"><canvas id="providerChart"></canvas></div>
</section>

<section>
<h2>Veicoli in Service per Tipo</h2>
<div class="chart-box"><canvas id="serviceChart"></canvas></div>
</section>

<!-- ===== KPI ===== -->
<section>
<h2>KPI Commerciali (Filtrabili)</h2>
<div class="grid">
  <div class="card"><h4>Revenue Totale</h4><span id="kpiRevenue">–</span></div>
  <div class="card"><h4>Revenue / Giorno</h4><span id="kpiRevDay">–</span></div>
  <div class="card"><h4>Prenotazioni</h4><span id="kpiBookings">–</span></div>
  <div class="card"><h4>Ancillaries</h4><span id="kpiAnc">–</span></div>
  <div class="card"><h4>Incidenti €</h4><span id="kpiInc">–</span></div>
</div>
</section>

<!-- ===== ANALISI ===== -->
<section>
<h2>Prenotazioni per Canale</h2>
<div class="chart-box"><canvas id="channelChart"></canvas></div>
</section>

<section>
<h2>Peak Analysis – Prenotazioni Giornaliere</h2>
<div class="chart-box large"><canvas id="timeChart"></canvas></div>
</section>

<!-- ===== TABELLA ===== -->
<section>
<h2>Performance Operativa</h2>
<table>
<thead>
<tr>
  <th>Branch</th>
  <th>Agente</th>
  <th>Revenue</th>
  <th>Prenotazioni</th>
</tr>
</thead>
<tbody id="perfTable"></tbody>
</table>
</section>

<script>
Chart.defaults.maintainAspectRatio = false;

const COLORS = {
  primary: "#1f3c88",
  secondary: "#4f81bd",
  accent: "#f28e2b"
};

let charts = {};

/* ===== LOAD DATA ===== */
Promise.all([
  fetch("fleet.json").then(r=>r.json()),
  fetch("utilization.json").then(r=>r.json()),
  fetch("service.json").then(r=>r.json()),
  fetch("incidenti.json").then(r=>r.json()),
  fetch("bookings.json").then(r=>r.json())
]).then(init);

/* ===== UTILS ===== */
function parseDateTime(dt){
  if(!dt) return null;
  const [d,t]=dt.split(" ");
  const [dd,mm,yyyy]=d.split("/");
  const [hh,min]=t.split(":");
  return new Date(yyyy,mm-1,dd,hh,min);
}

function group(data,key){
  return data.reduce((o,b)=>{
    o[b[key]] = (o[b[key]]||0)+1;
    return o;
  },{});
}

/* ===== INIT ===== */
function init([fleet,util,service,incidents,raw]){

  /* ----- FLOTTA CARDS ----- */
  fleetCards.innerHTML += card("Flotta Totale", fleet.length);

  util.forEach(u=>{
    fleetCards.innerHTML += card(
      "Occupazione " + u["Branch Offices"],
      (u.Occupation*100).toFixed(1) + "%"
    );
  });

  const avg = util.reduce((s,u)=>s+u.Occupation,0)/util.length;
  fleetCards.innerHTML += card("Occupazione Media",(avg*100).toFixed(1)+"%");

  /* ----- NORMALIZZA BOOKINGS ----- */
  const bookings = raw.map(b=>({
    branch: b["brach office"]?.trim(),
    agent: b.agent?.trim(),
    provider: b.Provider?.trim(),
    channel: b.channel,
    revenue: Number(b.revenue||0),
    ancillaries: Number(b["Ancillaries vendute"]||0),
    date: parseDateTime(b.from)
  }));

  populate(branchFilter, bookings.map(b=>b.branch));
  populate(agentFilter, bookings.map(b=>b.agent));

  branchFilter.onchange = apply;
  agentFilter.onchange = apply;
  fromDate.onchange = apply;
  toDate.onchange = apply;

  /* ----- SERVICE CHART ----- */
  charts.service = new Chart(serviceChart,{
    type: "bar",
    data: {
      labels: Object.keys(group(service,"type")),
      datasets: [{
        data: Object.values(group(service,"type")),
        backgroundColor: COLORS.secondary
      }]
    }
  });

  function apply(){
    const filtered = bookings.filter(b=>{
      if(branchFilter.value && b.branch!==branchFilter.value) return false;
      if(agentFilter.value && b.agent!==agentFilter.value) return false;
      if(fromDate.value && b.date < new Date(fromDate.value)) return false;
      if(toDate.value && b.date > new Date(toDate.value)) return false;
      return true;
    });

    updateKPIs(filtered, incidents);
    drawCharts(filtered);
    updateTable(filtered);
  }
  apply();
}

/* ===== KPI ===== */
function updateKPIs(d,inc){
  const revenue = d.reduce((s,b)=>s+b.revenue,0);
  const days = [...new Set(d.map(b=>b.date.toISOString().slice(0,10)))].length||1;

  kpiRevenue.textContent = "€ " + revenue.toFixed(2);
  kpiRevDay.textContent = "€ " + (revenue/days).toFixed(2);
  kpiBookings.textContent = d.length;
  kpiAnc.textContent = "€ " + d.reduce((s,b)=>s+b.ancillaries,0).toFixed(2);
  kpiInc.textContent = "€ " + inc.reduce((s,i)=>s+(i["Total price"]||0),0).toFixed(2);
}

/* ===== CHARTS ===== */
function drawCharts(d){
  Object.values(charts).forEach(c=>c&&c.destroy());

  charts.provider = new Chart(providerChart,{
    type: "bar",
    data: {
      labels: Object.keys(group(d,"provider")),
      datasets: [{
        label: "Prenotazioni",
        data: Object.values(group(d,"provider")),
        backgroundColor: COLORS.primary
      }]
    }
  });

  charts.channel = new Chart(channelChart,{
    type: "doughnut",
    data: {
      labels: Object.keys(group(d,"channel")),
      datasets: [{
        data: Object.values(group(d,"channel")),
        backgroundColor: Object.keys(group(d,"channel"))
          .map(l=>l.toLowerCase().includes("walk")?COLORS.accent:COLORS.secondary)
      }]
    }
  });

  const daily={};
  d.forEach(b=>{
    const k=b.date.toISOString().slice(0,10);
    daily[k]=(daily[k]||0)+1;
  });

  charts.time = new Chart(timeChart,{
    type: "line",
    data: {
      labels: Object.keys(daily),
      datasets: [{
        label: "Prenotazioni",
        data: Object.values(daily),
        borderColor: COLORS.primary,
        fill: false
      }]
    }
  });
}

/* ===== TABLE ===== */
function updateTable(d){
  perfTable.innerHTML="";
  const g={};

  d.forEach(b=>{
    const k=b.branch+"|"+b.agent;
    g[k]=g[k]||{b:b.branch,a:b.agent,r:0,c:0};
    g[k].r+=b.revenue;
    g[k].c++;
  });

  Object.values(g).forEach(x=>{
    perfTable.innerHTML+=`
      <tr>
        <td>${x.b}</td>
        <td>${x.a}</td>
        <td>€ ${x.r.toFixed(2)}</td>
        <td>${x.c}</td>
      </tr>`;
  });
}

function card(t,v){
  return `<div class="card"><h4>${t}</h4><span>${v}</span></div>`;
}

function populate(el,arr){
  [...new Set(arr.filter(Boolean))]
    .sort()
    .forEach(v=>el.innerHTML+=`<option>${v}</option>`);
}
</script>

</body>
</html>
