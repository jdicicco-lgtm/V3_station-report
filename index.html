<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Dashboard Performance – Dicembre 2025</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(180deg, #eef1f5 0%, #e6e9ee 100%);
  margin: 0 auto;
  padding: 20px;
  max-width: 1400px;
}

h1 { margin-bottom: 10px; }
h2 { margin: 25px 0 15px; font-size: 18px; }

section { margin-bottom: 35px; }

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
}

.card, .chart-box {
  background: #fbfcfe;
  padding: 18px;
  border-radius: 10px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.06);
}

.card span { font-size: 26px; font-weight: bold; }

select {
  padding: 6px;
  margin-right: 10px;
}

.chart-box {
  height: 320px;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: #fbfcfe;
}

th, td {
  padding: 8px;
  border-bottom: 1px solid #ddd;
}

th {
  background: #f0f2f6;
  font-size: 13px;
  text-transform: uppercase;
}

@media (min-width: 1600px) {
  body { max-width: 1600px; }
}
</style>
</head>

<body>

<h1>Dashboard Performance – Dicembre 2025</h1>

<section>
<select id="branchFilter"><option value="">Tutti i Branch</option></select>
<select id="agentFilter"><option value="">Tutti gli Agenti</option></select>
</section>

<section>
<h2>KPI Commerciali</h2>
<div class="grid">
  <div class="card"><h4>Revenue Totale</h4><span id="revTot">–</span></div>
  <div class="card"><h4>Prenotazioni</h4><span id="bookTot">–</span></div>
</div>
</section>

<section>
<h2>Analisi Prenotazioni</h2>
<div class="grid">
  <div class="chart-box"><canvas id="channelChart"></canvas></div>
  <div class="chart-box"><canvas id="providerChart"></canvas></div>
</div>
</section>

<section>
<h2>Peak Analysis</h2>
<div class="chart-box" style="height:360px">
  <canvas id="timeChart"></canvas>
</div>
</section>

<section>
<h2>Performance Operativa</h2>
<table>
<thead>
<tr><th>Branch</th><th>Agente</th><th>Revenue</th><th>Prenotazioni</th></tr>
</thead>
<tbody id="perfTable"></tbody>
</table>
</section>

<script>
Chart.defaults.maintainAspectRatio = false;

const COLORS = {
  primary:"#1f3c88",
  secondary:"#4f81bd",
  accent:"#f28e2b"
};

let charts = {};

Promise.all([
  fetch("bookings.json").then(r=>r.json())
]).then(([bookings]) => init(bookings));

function parseDate(d){
  if(!d) return null;
  const p=d.split("/");
  return new Date(p[2],p[1]-1,p[0]);
}

function init(bookingsRaw){

  const bookings = bookingsRaw.map(b => ({
    branch: b["Branch"] || b["Branch Office"] || "N/D",
    agent: b["Agent"] || b["Created by"] || "N/D",
    revenue: Number(b["Revenue"] || b["Total price"] || 0),
    date: parseDate(b["Creation date"] || b["Date"]),
    channel: b["Channel"] || "Altro",
    provider: b["Provider"] || "Altro"
  }));

  populate("branchFilter", bookings.map(b=>b.branch));
  populate("agentFilter", bookings.map(b=>b.agent));

  branchFilter.onchange = apply;
  agentFilter.onchange = apply;

  function apply(){
    const f = bookings.filter(b =>
      (!branchFilter.value || b.branch===branchFilter.value) &&
      (!agentFilter.value || b.agent===agentFilter.value)
    );
    updateKPIs(f);
    drawCharts(f);
    updateTable(f);
  }
  apply();
}

function updateKPIs(d){
  revTot.textContent="€ "+d.reduce((s,b)=>s+b.revenue,0).toFixed(2);
  bookTot.textContent=d.length;
}

function drawCharts(d){
  destroy();

  charts.channel = new Chart(channelChart,{
    type:"doughnut",
    data:{
      labels:Object.keys(group(d,"channel")),
      datasets:[{data:Object.values(group(d,"channel")),backgroundColor:[COLORS.accent,COLORS.secondary]}]
    }
  });

  charts.provider = new Chart(providerChart,{
    type:"bar",
    data:{
      labels:Object.keys(group(d,"provider")),
      datasets:[{data:Object.values(group(d,"provider")),backgroundColor:COLORS.primary}]
    }
  });

  const daily={};
  d.forEach(b=>{
    if(!b.date) return;
    const k=b.date.toISOString().slice(0,10);
    daily[k]=(daily[k]||0)+1;
  });

  charts.time=new Chart(timeChart,{
    type:"line",
    data:{labels:Object.keys(daily),datasets:[{data:Object.values(daily),label:"Prenotazioni"}]}
  });
}

function updateTable(d){
  perfTable.innerHTML="";
  const g={};
  d.forEach(b=>{
    const k=b.branch+"|"+b.agent;
    g[k]=g[k]||{b:b.branch,a:b.agent,r:0,c:0};
    g[k].r+=b.revenue; g[k].c++;
  });
  Object.values(g).forEach(x=>{
    perfTable.innerHTML+=`<tr><td>${x.b}</td><td>${x.a}</td><td>€ ${x.r.toFixed(2)}</td><td>${x.c}</td></tr>`;
  });
}

function populate(id,arr){
  const el=document.getElementById(id);
  [...new Set(arr)].sort().forEach(v=>el.innerHTML+=`<option>${v}</option>`);
}

function group(d,k){
  return d.reduce((o,b)=>{o[b[k]]=(o[b[k]]||0)+1;return o;},{});
}

function destroy(){
  Object.values(charts).forEach(c=>c.destroy());
}
</script>

</body>
</html>
